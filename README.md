
#### ç›®å½•

ğŸ§ [**å‰ è¨€**](#å‰è¨€)  <br />
âœ¨ [åˆ†å¸ƒå¼äº‹åŠ¡](#åˆ†å¸ƒå¼äº‹åŠ¡) <br />
â˜ï¸ [è·¨åº“æŸ¥è¯¢ è·¨åº“åˆ†é¡µæŸ¥è¯¢](#è·¨åº“æŸ¥è¯¢/è·¨åº“åˆ†é¡µæŸ¥è¯¢) <br />


**å‰è¨€**

è¯è¯´2021å¹´å¼€å§‹äº†ä¸€ä¸ªåŸºäºASP.NET Core On Kubernetes å¾®æœåŠ¡çš„é¡¹ç›®ï¼Œè°ˆåˆ°å¾®æœåŠ¡ å¤šåº“ç¯å¢ƒä¸‹ åˆ†å¸ƒå¼äº‹åŠ¡ã€åˆ†åº“åˆ†è¡¨è¿™äº›é—®é¢˜éƒ½æ˜¯é€ƒä¸å¼€çš„ï¼Œäºæ˜¯é¦–å…ˆä»ORMå¼€å§‹è°ƒç ”ï¼Œç”±äºæˆ‘èº«ä¸ºè¿™ä¸ªé¡¹ç›®çš„æ¶æ„å¸ˆ  è¿˜æ˜¯è¦è€ƒè™‘åˆ°ä¸€äº›é‡è¦çš„å› ç´  **åŠŸèƒ½å¼ºå¤§ã€æ”¯æŒå¤šç§æ•°æ®åº“ï¼ˆå¹¶ä¸”è¡Œä¸ºä¸€è‡´ï¼Œé˜²æ­¢å‡ºç°æ¢åº“çš„æƒ…å†µï¼‰ã€æ”¯æŒåˆ†åº“åˆ†è¡¨** ç­‰ç­‰ï¼Œè¿™æ—¶å€™ç¬¬ä¸€æ—¶é—´å°±æƒ³åˆ°äº† [FreeSql](https://github.com/dotnetcore/FreeSql)  ï¼ŒFreeSqlçš„æ¶æ„è®¾è®¡éå¸¸å¥½ï¼Œæ¯ä¸€ç§æ”¯æŒçš„æ•°æ®åº“éƒ½æœ‰å¯¹åº”çš„Providerå®ç° åšåˆ°è¡Œä¸ºä¸€è‡´ï¼Œè€Œä¸”æ”¯æŒCodeFirstå’ŒDbFirstï¼Œåˆ†åº“åˆ†è¡¨FreeSqlä¹Ÿæœ‰æ¯”è¾ƒç®€å•åˆ‡æœ‰æ•ˆçš„æ–¹æ¡ˆï¼Œæœ¬äººä¹Ÿç»å¸¸å‘FreeSqlçš„ä½œè€…å¶è€æ¿è¯·æ•™å­¦ä¹ ï¼Œéå¸¸ä½©æœä»–çš„æŠ€æœ¯ä¸äººå“ï¼Œä¹Ÿéå¸¸æ„Ÿè°¢ä»–èƒ½åšå‡ºè¿™ä¹ˆå¥½çš„ORMæ¡†æ¶ã€‚

**åˆ†å¸ƒå¼äº‹åŠ¡**

æ—¢ç„¶åˆ†åº“äº† åˆ†å¸ƒå¼äº‹åŠ¡æ€ä¹ˆå¤„ç†ï¼Œè¯´åˆ°åˆ†å¸ƒå¼äº‹åŠ¡ å¸¸è§çš„è§£å†³æ–¹æ¡ˆæœ‰TCC/SAGA/æ¶ˆæ¯é˜Ÿåˆ—æœ€ç»ˆä¸€è‡´æ€§ï¼Œåœ¨.NETç”Ÿæ€ä¸­æœ‰åŸºäºæ¶ˆæ¯é˜Ÿåˆ—å®ç°çš„åˆ†å¸ƒå¼äº‹åŠ¡ [CAP](https://github.com/dotnetcore/CAP) ï¼ŒTCCå’ŒSAGAè°ƒç ”äº†å¾ˆä¹…æ²¡æœ‰å‘ç°æœ‰æ¯”è¾ƒæˆç†Ÿçš„å®ç°ï¼Œé‚£ä¹ˆå°±å†³å®šä½¿ç”¨`CAPï¼ˆæœ€ç»ˆä¸€è‡´æ€§äº‹åŠ¡ï¼‰` ç”±äºé¡¹ç›®æŒç»­çš„æ”¹ç‰ˆï¼Œä¸šåŠ¡çš„å®æ—¶æ€§å˜å¾—è¶Šæ¥è¶Šé«˜ï¼ŒåŸºäºæ¶ˆæ¯é˜Ÿåˆ—çš„è¿™ç§æœ€ç»ˆä¸€è‡´æ€§æˆ–è€…è¯´å¼‚æ­¥äº‹åŠ¡çš„æ–¹æ¡ˆ è¶Šæ¥è¶Šä¸é€‚åˆæˆ‘ä»¬çš„é¡¹ç›®ï¼Œè¿™æ—¶å€™å°±éœ€è¦åŒæ­¥çš„äº‹åŠ¡æ–¹æ¡ˆï¼ŒTCC/SAGEåˆæ²¡æœ‰å¤ªå¥½çš„è§£å†³æ–¹æ¡ˆï¼ˆæˆ‘çœŸçš„æ²¡æœ‰æ‰¾åˆ°ã€‚ã€‚ï¼‰ï¼Œäºæ˜¯æƒ³ç€è‡ªå·±è®¾è®¡ä¸€ä¸ªï¼ŒåŸºäºFreeSqlå®ç°äº‹åŠ¡ç®¡ç†å™¨ã€‚

æƒ³è¦çš„æ•ˆæœï¼šå’Œå•åº“äº‹åŠ¡ä¸€æ ·ï¼Œå‡ºç°é”™è¯¯å›æ»š ä½†æ˜¯é—®é¢˜æ¥äº† å¤šåº“å‘¢ï¼Ÿä¸åŒçš„æ•°æ®åº“å‘¢ï¼Ÿ

* åœ¨å¤šåº“äº‹åŠ¡çš„å¼€å¯æ—¶ï¼Œæ¯ä¸ªåº“ç®¡ç†å¼€å¯è‡ªå·±çš„äº‹åŠ¡
* åœ¨å¤šåº“äº‹åŠ¡æäº¤æ—¶ï¼Œæ¯ä¸ªåº“çš„äº‹åŠ¡ç»Ÿä¸€æäº¤
* å¦‚æœæŸä¸€ä¸ªåº“äº‹åŠ¡å‡ºç°å¼‚å¸¸ï¼Œè¿™å›æ»šå…¨éƒ¨æ•°æ®åº“äº‹åŠ¡
* è®°å½•æ—¥å¿—ï¼Œç¬¬ä¸€ä¸ªæ‰§è¡ŒCommonçš„æ•°æ®åº“ç§°ä¹‹ä¸ºä¸»åº“ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ—¥å¿—è¡¨ï¼Œç”¨äºè®°å½•å¤šåº“äº‹åŠ¡çš„ä¿¡æ¯ã€æ‰§è¡Œçš„SQLã€ä¸šåŠ¡æ¨¡å— ç”¨äºäººå·¥ä»‹å…¥æˆ–è€…äº‹åŠ¡è¡¥å¿
* å¦‚æœç¬¬ä¸€ä¸ªåº“å‘ç”ŸCommonåï¼Œå…¶ä»–åº“å¯èƒ½ç”±äºç½‘ç»œåŸå› ã€æ•°æ®åº“å®•æœº æ— æ³•Commonäº‹åŠ¡ï¼Œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ï¼Œè¿™æ—¶å€™è¦è¿›è¡Œäº‹åŠ¡è¡¥å¿æˆ–è€…äººå·¥ä»‹å…¥

![image](https://user-images.githubusercontent.com/54463101/208339387-8a7cabf4-1afa-43a1-ac62-9f08f89c83fd.png)

**è·¨åº“æŸ¥è¯¢/è·¨åº“åˆ†é¡µæŸ¥è¯¢**

é€šè¿‡æ—¶é—´åˆ†ç‰‡å®šä½ã€äº‹ä»¶å§”æ‰˜ã€åˆ†é¡µç®—æ³•å®ç°è·¨åº“åˆ†é¡µæŸ¥è¯¢

#### 1.appsettings.jsonä¸­æ·»åŠ ä¸€ä¸‹é…ç½® 

~~~json
  "ShowSqlLog": true,   //æ˜¯å¦æ˜¾ç¤ºSQLæ—¥å¿—
  //æ•°æ®åº“é…ç½®ä¿¡æ¯
  "CustomDbConfig": [
    {
      "Key": "sharingcore_basics", //æ•°æ®åº“åå³å¯
      "Identification": "sharingcore_basics",
      "DataType": "MySql",
      "ConnectString": "Data Source=host;Port=Port;User ID=root;Password=123;Initial Catalog=sharingcore_basics;Charset=utf8;SslMode=none;AllowLoadLocalInfile=true;",
      "Slaves": [
      ]
    },
    //ä¸šåŠ¡åº“2022ã€åˆ†åº“
    {
      "Key": "sharingcore_business_2022",
      "Identification": "sharingcore_business", //é™¤å»æ—¥æœŸçš„æ ‡è¯†
      "DataType": "MySql",
      "ConnectString": "Data Source=host;Port=Port;User ID=root;Password=123;Initial Catalog=sharingcore_business_2022;Charset=utf8;SslMode=none;AllowLoadLocalInfile=true;",
      "Slaves": [
      ]
    },
    //ä¸šåŠ¡åº“2023ã€åˆ†åº“
    {
      "Key": "sharingcore_business_2023",
      "Identification": "sharingcore_business",
      "DataType": "MySql",
      "ConnectString": "Data Source=host;Port=Port;User ID=root;Password=123;Initial Catalog=sharingcore_business_2022;Charset=utf8;SslMode=none;AllowLoadLocalInfile=true;",
      "Slaves": [
      ]
    },
    //æ—¥å¿—æ—¶åºæ•°æ®åº“ ä¸åˆ†åº“
    {
      "Key": "sharingcore_log",
      "Identification": "sharingcore_log",
      "DataType": "MySql",
      "ConnectString": "host=host;port=8812;username=admin;password=quest;database=qdb;ServerCompatibilityMode=NoTypeLoading;",
      "Slaves": [
      ]
    }

  ]
~~~

#### 2.åˆå§‹åŒ–æ•°æ®åº“

> åˆ›å»ºSharingCoreDbsæ‰©å±•æ–¹æ³•

~~~C#
/// <summary>
/// åŸºç¡€åº“
/// </summary>
/// <param name="dbs"></param>
/// <returns></returns>
public static string Basics(this SharingCoreDbs dbs) => "sharingcore_basics";

/// <summary>
/// ä¸»ä¸šåŠ¡åº“
/// </summary>
/// <param name="dbs"></param>
/// <returns></returns>
[Database(Name = "sharingcore_business_{yyyy}", Separate = "createtime=2022-01-01(1 year)")]
public static string Business(this SharingCoreDbs dbs) => "sharingcore_business";

/// <summary>
/// æ—¥å¿—åº“
/// </summary>
/// <param name="dbs"></param>
/// <returns></returns>
public static string Logs(this SharingCoreDbs dbs) => "sharingcore_log";
~~~

> å¯ä»¥åˆ›å»ºGlobalUsings.csæ›´æ–¹é¢

~~~c#
global using static SharingCore.MultiDatabase.Wrapper.SharingCores;
global using SharingCore;
~~~

> ASP.NET Core 6.0/7.0 Program.csä¸­

~~~c#
var builder = WebApplication.CreateBuilder(args).InjectSharingCore(); //æ³¨å…¥
//ç®€å•æ–¹å¼
services.AddSharingCore(options =>
{
   options.DBConfigKey = "CustomDbConfig";  //æŒ‡å®šé…ç½®æ–‡ä»¶ä¸­çš„KEYï¼Œå¦‚ä¸æŒ‡å®š é»˜è®¤ä¸º SharingCoreDbConfig
});
//å…¨å±€è¿‡æ»¤å™¨
builder.Services.AddSharingCore<FreeSqlFilter>(f => f.isDelete == 0);
//å¤æ‚æ„å»º
builder.Services.AddSharingCore(new Dictionary<string, Expression<Func<FreeSqlFilter, bool>>>() //å®šåˆ¶ä¸åŒåº“çš„è¿‡æ»¤å™¨
{
    { Dbs.Basics(), f => f.isDelete == 0 }, //åŸºç¡€åº“å…¨å±€è¿‡æ»¤å™¨
    { Dbs.Logs(), f => false }, //æ­¤åº“ä¸æŒ‡å®šè¿‡æ»¤å™¨
    { FreeSqlFilterType.Communal, f => f.isDelete == 0 } //å…¶ä»–åº“å…¬ç”¨çš„è¿‡æ»¤å™¨
}, options =>
{
    options.DBConfigKey = "CustomDbConfig"; //æŒ‡å®šé…ç½®æ–‡ä»¶ä¸­çš„KEYï¼Œå¦‚ä¸æŒ‡å®š é»˜è®¤ä¸º SharingCoreDbConfig
    options.DemandLoading = true; //æŒ‰éœ€åŠ è½½
    //FreeSqlBuilderæ—¶å€™æ¯ä¸ªåº“å¯ä»¥æ‰©å±•
    options.FreeSqlBuildersInject = new Dictionary<string, Func<FreeSqlBuilder, FreeSqlBuilder>>()
    {
        {
            Dbs.Logs(), //æ—¥å¿—åº“QuestDbåœ¨FreeSqlBuilderéœ€è¦åˆ¶å®šRestAPIé…ç½®
            builder => builder.UseQuestDbRestAPI("192.168.0.36:9001", "admin", "ushahL(aer2r")
        }
    };
});
~~~

* **æŒ‰éœ€åŠ è½½ï¼šä¾‹å¦‚ é…ç½®æ–‡ä»¶ä¸­æœ‰30ä¸ªæ•°æ®åº“ä½†æ˜¯ä¸åŒçš„å·¥ä½œæœåŠ¡ä¸­ä¼šç”¨åˆ°ä¸åŒçš„æ•°æ®åº“ å¹¶ä¸æƒ³å…¨éƒ½åŠ è½½ï¼Œè¿™æ—¶å€™å¯ä»¥æ¯ä¸€ä¸ªæœåŠ¡è‡ªå®šä¹‰SharingCoreDbsæ‰©å±•æ–¹æ³• æ¥æ§åˆ¶åŠ è½½æ•°æ®åº“ï¼ŒSharingCoreä¼šæ ¹æ®æ‰©å±•æ–¹æ³•è¿›è¡ŒåŠ è½½æ•°æ®åº“**

> ASP.NET Core 3.1/5.0 Program.csä¸­

~~~C#
 public static IHostBuilder CreateHostBuilder(string[] args) =>
     Host.CreateDefaultBuilder(args)
     .InjectSharingCore()  //æ³¨å…¥
~~~

#### 3.è·å–IFreeSqlæ“ä½œå¯¹è±¡

~~~c#
//ä¸åˆ†åº“
var Logs = Dbs.Logs().GetFreeSql().Ado.Query<string>("select 1"); 
//ä¸åˆ†åº“
var Basics = Dbs.Basics().GetFreeSql().Ado.Query<string>("select 1");
//é€šè¿‡å¹´å®šä½åº“
var Business_2022 = Dbs.Business().GetFreeSql("2022").Ado.Query<string>("select 1"); 
//ç›´æ¥è·å–å½“å‰å¹´æ•°æ®åº“
var Business_2023 = Dbs.Business().GetNowFreeSql().Ado.Query<string>("select 1"); 
~~~

#### 5.è·¨åº“åˆ†é¡µæŸ¥è¯¢

~~~C#
var result = SharingCores.QueryPageList(query =>
{
    var result = query.Db.Select<order>().PageCore(query, out var count)
     			.ToListCore(o => o, query, count);
                    return new QueryFuncResult<order>(result, count);
},param => param.Init(Dbs.Business(), 10, page, DateTime.Parse("2022-12-28"),DateTime.Parse("2023-01-04")),out var total);
Console.WriteLine($"æ€»æ¡æ•°:{total}ï¼ŒæŸ¥è¯¢æ¡æ•°ï¼š{result.Count}");
~~~

#### 6. è·¨åº“å¢åˆ æ”¹

~~~C#
//åªä¼šå¾€å½“å‰å¹´åº“é‡Œæ’å…¥
var executeAffrows = Business_Now.Insert(new order
{
    commodity_name = "iwatch",
    order_time = DateTime.Now,
    buyer_name = "å¼ ä¸‰"
}).ExecuteAffrows();
Console.WriteLine(executeAffrows);

//é€šè¿‡æ—¥æœŸèŒƒå›´è¿›è¡Œæ’å…¥ 
SharingCores.NoQuery<order>(noQuery =>
    {
        noQuery.Db.Insert(new order
            {
                commodity_name = "iwatch",
                order_time = DateTime.Now,
                buyer_name = "å¼ ä¸‰"
            })
            .WithTransaction(noQuery.Transaction) //å¯ä»¥ä¿è¯è·¨åº“äº‹åŠ¡
            .ExecuteAffrows();
    },
    param => param.Init(Dbs.Business(), DateTime.Parse("2023-02-03"),
        DateTime.Parse("2023-02-03")), //åªä¼šå†™å…¥åˆ°2023å¹´çš„åº“
    //äº‹åŠ¡è¡¥å¿
    (logId, dbWarp, exception) => { });

SharingCores.NoQuery<order>(noQuery =>
    {
        noQuery.Db.Insert(new order
            {
                commodity_name = "iwatch",
                order_time = DateTime.Now,
                buyer_name = "å¼ ä¸‰"
            })
            .WithTransaction(noQuery.Transaction) //å¯ä»¥ä¿è¯è·¨åº“äº‹åŠ¡
            .ExecuteAffrows();
        var next = new Random().Next(2);
        if (next == 1)
        {
            throw new Exception();
        }
    },
    param => param.Init(Dbs.Business(), DateTime.Parse("2022-02-03"),
        DateTime.Parse("2023-02-03")), //2022å’Œ2023å¹´åº“å‡å†™å…¥
    // äº‹åŠ¡è¡¥å¿
    (logId, dbWarp, exception) => { })
~~~

#### 7.è·¨åº“å¹¶è¡ŒæŸ¥è¯¢ï¼ˆä¸åˆ†é¡µï¼‰

~~~C#
var list = await SharingCores.QueryAsync(query =>
{
      var list = query.Db.Select<order>()
      .Where(o => o.order_time.Value.BetweenEnd(query.StartTime, query.EndTime)).ToList();
       return list;
}, query => query.Init(Dbs.Business(), DateTime.Parse("2022-02-01"), DateTime.Parse("2023-05-01")));
Console.WriteLine(list.Count);
~~~

#### 8.è·¨åº“ToOneæŸ¥è¯¢

~~~C# 
var list = await SharingCores.QueryToOneAsync(query =>
{
      var list = query.Db.Select<order>()
      .Where(o => o.id == 199).ToList();
      return list;
}, query => query.Init(Dbs.Business(), DateTime.Parse("2022-02-01"), DateTime.Parse("2023-05-01")));
Console.WriteLine(list.Count);
~~~

#### 9.è·¨åº“AnyæŸ¥è¯¢

~~~C# 
var list = await SharingCore.QueryAnyAsync(func =>
{
    var list = func.Db.Select<vehicleLudan>()
        .Where(l => l.dateLudan.Value.BetweenEnd(func.StartTime, func.EndTime))
        .Where(l => l.id = "1")
        .ToList();
    return list;
}, query => query.Init(DBAll.Business, start, end));
~~~

#### 10.åˆ†å¸ƒå¼äº‹åŠ¡ã€å¤šåº“äº‹åŠ¡

~~~C#
var businessWarp = Dbs.Business().GetNowDbWarp();
var basicsWarp = Dbs.Basics().GetDbWarp();
using (var tran = SharingCores.Transaction(businessWarp, basicsWarp))
{
    tran.OnCommitFail += TransactionCompensation;
    try
    {
        tran.BeginTran();
        var r1 = tran.Orm1.Insert(new order
                                  {
                                      buyer_name = $"äº‹åŠ¡{i}",
                                      commodity_name = "äº‹åŠ¡",
                                      order_time = DateTime.Now
                                  }).ExecuteAffrows();

        var r2 = tran.Orm2.Insert<users>(new users()
                                         {
                                             name = $"äº‹åŠ¡{i}",
                                             password = "123",
                                             username = "1231"
                                         }).ExecuteAffrows();
        if (new Random().Next(5) == 1)
        {
            throw new Exception("");
        }

        var log = new multi_transaction_log()
        {
            content = $"{i}åˆ†å¸ƒå¼äº‹åŠ¡æµ‹è¯•...",
        };
        //æäº¤äº‹åŠ¡å¹¶è¿”å›ç»“æœ
        var result = tran.Commit(log);
        Console.WriteLine(result);
    }
    catch
    {
        tran.Rellback();
    }
}

   //å¦‚æœç¬¬ä¸€ä¸ªåº“æäº¤æˆåŠŸï¼Œå…¶ä»–åº“æäº¤çš„è¿‡ç¨‹ä¸­å¤±è´¥ï¼Œé‚£ä¹ˆå°†è¿™é‡Œè¿›è¡Œäº‹åŠ¡è¡¥å¿
void TransactionCompensation(string logId, DbWarp dbWarp, Exception ex)
{
    //æ—¥å¿—ä¸­æœ‰è®°å½•SQL
    var id = Convert.ToInt64(logId);
    //è¿™é‡Œçš„DBWarpæ˜¯æ—¥å¿—å­˜å‚¨æ‰€åœ¨çš„æ•°æ®åº“
    var log = dbWarp.Instance.Select<multi_transaction_log>().Where(b => b.id ==
                                                                    id).ToOne();
    //æ‹¿åˆ°å¤šåº“äº‹åŠ¡æ‰§è¡Œçš„ä¿¡æ¯
    var log_result = JsonConvert.DeserializeObject<List<TransactionsResult>>
        (log.result_msg);
    foreach (var transactionsResult in log_result)
    {
        //æ‹¿åˆ°å¤±è´¥Commonå¤±è´¥çš„æ•°æ®åº“
        if (transactionsResult.Successful == false)
        {
            //å¤±è´¥æ•°æ®åº“çš„KEY
            var failDb = transactionsResult.Key;
            //è·å–æ•°æ®åº“æ“ä½œå¯¹è±¡å‡†å¤‡æ‰§è¡Œäº‹åŠ¡è¡¥å¿
            var tempDb = failDb.GetFreeSql();
            //æ‹¿åˆ°åœ¨åˆ†å¸ƒå¼äº‹åŠ¡ä¸­è¿™ä¸ªåº“æ‰€Commonå¤±è´¥çš„SQL
            var sqls = log.exec_sql;
            var sqlsDic = JsonConvert.DeserializeObject<Dictionary<string,
            List<string>>>(sqls);
            var sqlsList = sqlsDic[failDb];
            //äº‹åŠ¡è¡¥å¿ï¼Œæ‰§è¡Œåœ¨Commonæ—¶æ²¡æœ‰æˆåŠŸçš„SQL
            tempDb.Transaction(() => {
                foreach (var noQuerySql in sqlsList)
                {
                    tempDb.Ado.ExecuteNonQuery(noQuerySql);
                }

                if (dbWarp.Instance.Delete<multi_transaction_log>().Where(m => m.id == id).ExecuteAffrows() == 0)
                {
                    throw new Exception("å¦‚æœåˆ é™¤æ—¥å¿—å¤±è´¥ï¼Œå›æ»šSQL..");
                }
            });
            Console.WriteLine("äº‹åŠ¡è¡¥å¿æˆåŠŸ...");
        }
    }
}
~~~
